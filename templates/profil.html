{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}My Profile{% endblock %}

{% block container_titre %}
<i class="bi bi-person-circle me-1"></i> My Profile
{% endblock %}

{% block container %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-7 col-md-9">

      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">

          <!-- HEADER -->
          <div class="text-center mb-4">

            <!-- AVATAR (Bootstrap only) -->
            <div class="mx-auto mb-3 ratio ratio-1x1 rounded-circle overflow-hidden border border-3 border-primary"
                 style="width:120px;">
              <img
                id="avatarPreview"
                {% if user.profile.avatar %}
                  src="{{ user.profile.avatar.url }}"
                {% else %}
                  src="{% static 'image/default.jpg' %}
                {% endif %}
                class="w-100 h-100"
                style="object-fit:cover;"
                alt="avatar">
            </div>

            <h4 class="fw-bold mb-0">{{ user.username }}</h4>
            <p class="text-muted small">{{ user.email }}</p>
          </div>

          <!-- META -->
          <div class="row text-center text-muted small mb-4">
            <div class="col">
              <i class="bi bi-calendar-check"></i><br>
              Joined<br>
              <strong>{{ user.date_joined|date:"d/m/Y" }}</strong>
            </div>
            <div class="col">
              <i class="bi bi-clock-history"></i><br>
              Last login<br>
              <strong>{{ user.last_login|naturaltime }}</strong>
            </div>
          </div>

          <hr>

          <!-- FORM -->
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="bi bi-image me-1"></i> Change avatar
              </label>
              <input
                type="file"
                name="avatar"
                class="form-control"
                accept="image/*"
                onchange="previewAvatar(this)">
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-person-fill me-1"></i> First name
                </label>
                <input type="text" name="first_name"
                       class="form-control"
                       value="{{ user.first_name }}">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-person-fill me-1"></i> Last name
                </label>
                <input type="text" name="last_name"
                       class="form-control"
                       value="{{ user.last_name }}">
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-envelope-fill me-1"></i> Email
              </label>
              <input type="email" name="email"
                     class="form-control"
                     value="{{ user.email }}">
            </div>

            <button type="submit"
                    class="btn btn-primary w-100 py-2 fw-semibold">
              <i class="bi bi-save me-1"></i>
              Save changes
            </button>
          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- TOAST -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
  {% for message in messages %}
  <div class="toast show text-bg-success border-0 shadow">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- JS preview -->
<script>
function previewAvatar(input) {
  const preview = document.getElementById("avatarPreview");
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => preview.src = e.target.result;
    reader.readAsDataURL(file);
  }
}
</script>
{% endblock %}
